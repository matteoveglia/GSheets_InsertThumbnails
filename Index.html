<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h3 {
      color: #333;
    }
    form {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .button-container {
      display: flex;
      align-items: center;
      margin-top: 20px;
    }
    input[type="button"] {
      padding: 10px 20px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    input[type="button"]:hover {
      background-color: #0056b3;
    }
    .spinner {
      display: none;
      width: 24px;
      height: 24px;
      border: 4px solid lightgray;
      border-top-color: blue;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .checklist {
      list-style-type: none;
      padding: 0;
      margin-top: 20px;
    }
    .checklist li {
      display: flex;
      align-items: center;
      padding: 10px 0;
      font-weight: bold;
      color: #555;
    }
    .checklist li.in-progress {
      color: orange;
    }
    .checklist li.completed {
      color: green;
    }
    .disabled {
      pointer-events: none;
      opacity: 0.6;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <form id="imageForm">
    <label for="folderUrl">Folder URL:</label>
    <input type="text" id="folderUrl" name="folderUrl" placeholder="Enter Google Drive folder URL">
    
    <label for="startRow">Start Row:</label>
    <input type="number" id="startRow" name="startRow" placeholder="Enter start row number">
    
    <label for="startCol">Start Column:</label>
    <input type="number" id="startCol" name="startCol" placeholder="Enter start column number">
    
    <div class="button-container">
      <input type="button" id="submitButton" value="Insert Images" onclick="submitForm()">
      <div id="mainSpinner" class="spinner"></div>
    </div>
  </form>
  <ul class="checklist">
    <li id="step1">Initializing process</li>
    <li id="step2">Collecting files from folder</li>
    <li id="step3">Sorting files</li>
    <li id="step4">Inserting images into sheet</li>
    <li id="step5">Process completed</li>
  </ul>
  
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <p id="modalMessage"></p>
    </div>
  </div>
  
  <script>
    function submitForm() {
      disableForm(true);
      showSpinner('mainSpinner');
      document.getElementById('submitButton').value = 'Stop';
      document.getElementById('submitButton').onclick = stopScript;
      updateChecklist('step1', 'in-progress');

      const folderUrl = document.getElementById('folderUrl').value;
      const startRow = document.getElementById('startRow').value;
      const startCol = document.getElementById('startCol').value;

      google.script.run
        .withSuccessHandler(function() {
          updateChecklist('step1', 'completed');
          updateChecklist('step2', 'in-progress');
          google.script.run
            .withSuccessHandler(function() {
              updateChecklist('step2', 'completed');
              updateChecklist('step3', 'in-progress');
              google.script.run
                .withSuccessHandler(function() {
                  updateChecklist('step3', 'completed');
                  updateChecklist('step4', 'in-progress');
                  google.script.run
                    .withSuccessHandler(function(imagesInserted) {
                      updateChecklist('step4', 'completed');
                      updateChecklist('step5', 'completed');
                      resetForm();
                      showModal(imagesInserted);
                    })
                    .withFailureHandler(function() {
                      resetForm();
                      alert('Failed to insert images');
                    })
                    .insertImagesFromUI();
                })
                .withFailureHandler(function() {
                  resetForm();
                  alert('Failed to sort files');
                })
                .sortFiles();
            })
            .withFailureHandler(function() {
              resetForm();
              alert('Failed to collect files');
            })
            .collectFiles(folderUrl);
        })
        .withFailureHandler(function() {
          resetForm();
          alert('Failed to initialize process');
        })
        .initializeProcess(folderUrl, startRow, startCol);
    }

    function stopScript() {
      google.script.run.stopImageInsertion();
      resetForm();
    }

    function resetForm() {
      disableForm(false);
      hideSpinner('mainSpinner');
      resetChecklist();
      document.getElementById('submitButton').value = 'Insert Images';
      document.getElementById('submitButton').onclick = submitForm;
    }

    function updateChecklist(stepId, status) {
      const stepElement = document.getElementById(stepId);
      stepElement.classList.remove('in-progress', 'completed');
      stepElement.classList.add(status);
    }

    function resetChecklist() {
      const checklistItems = document.querySelectorAll('.checklist li');
      checklistItems.forEach(item => {
        item.classList.remove('in-progress', 'completed');
      });
    }

    function disableForm(disable) {
      const formElements = document.querySelectorAll('#imageForm input[type="text"], #imageForm input[type="number"]');
      formElements.forEach(element => {
        element.disabled = disable;
        if (disable) {
          element.classList.add('disabled');
        } else {
          element.classList.remove('disabled');
        }
      });
    }

    function showSpinner(spinnerId) {
      document.getElementById(spinnerId).style.display = 'inline-block';
    }

    function hideSpinner(spinnerId) {
      document.getElementById(spinnerId).style.display = 'none';
    }

    function showModal(imagesInserted) {
      const modal = document.getElementById('myModal');
      const message = document.getElementById('modalMessage');
      message.innerText = `Process completed with ${imagesInserted} images inserted.`;
      modal.style.display = 'block';
    }

    function closeModal() {
      const modal = document.getElementById('myModal');
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('myModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  </script>
</body>
</html>