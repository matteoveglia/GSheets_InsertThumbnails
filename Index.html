<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h3 {
      color: #333;
    }
    form {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .button-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 20px;
    }
    input[type="button"] {
      padding: 10px 20px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    input[type="button"]:hover {
      background-color: #0056b3;
    }
    .spinner {
      display: none;
      width: 24px;
      height: 24px;
      border: 4px solid lightgray;
      border-top-color: blue;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .checklist {
      list-style-type: none;
      padding: 0;
      margin-top: 20px;
    }
    .checklist li {
      display: flex;
      align-items: center;
      padding: 10px 0;
      font-weight: bold;
      color: #555;
    }
    .checklist li.in-progress {
      color: orange;
    }
    .checklist li.completed {
      color: green;
    }
    .disabled {
      pointer-events: none;
      opacity: 0.6;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    #modalMessage ol {
    max-height: 60vh;
    overflow-y: auto;
    padding-left: 40px; /* Increased padding */
    }
    #modalMessage li {
      margin-bottom: 5px;
      padding-left: 10px; /* Added padding */
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <form id="imageForm">
    <label for="folderUrl">Folder URL:</label>
    <input type="text" id="folderUrl" name="folderUrl" placeholder="Enter Google Drive folder URL" required>
    
    <label for="startRow">Start Row:</label>
    <input type="number" id="startRow" name="startRow" placeholder="Enter start row number" required>
    
    <label for="startCol">Start Column:</label>
    <input type="number" id="startCol" name="startCol" placeholder="Enter start column number" required>
    
    <div class="button-container">
      <input type="button" id="submitButton" value="Insert Images" onclick="submitForm()">
      <div id="mainSpinner" class="spinner"></div>
      <input type="button" id="previewButton" value="Preview Sort Order" onclick="previewSortOrder()">
      <div id="previewSpinner" class="spinner"></div>
    </div>
  </form>
  <ul class="checklist">
    <li id="step1">Initializing process</li>
    <li id="step2">Collecting files from folder</li>
    <li id="step3">Sorting files</li>
    <li id="step4">Inserting images into sheet</li>
    <li id="step5">Process completed</li>
  </ul>
  
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalMessage"></div>
    </div>
  </div>
  
  <script>
    function submitForm() {
      const folderUrl = document.getElementById('folderUrl').value;
      const startRow = document.getElementById('startRow').value;
      const startCol = document.getElementById('startCol').value;

      if (!folderUrl || !startRow || !startCol) {
        alert('Please fill in all the fields.');
        return;
      }

      disableForm(true);
      showSpinner('mainSpinner');
      document.getElementById('submitButton').value = 'Stop';
      document.getElementById('submitButton').onclick = stopScript;
      updateChecklist('step1', 'in-progress');

      google.script.run
        .withSuccessHandler(function() {
          updateChecklist('step1', 'completed');
          updateChecklist('step2', 'in-progress');
          google.script.run
            .withSuccessHandler(function() {
              updateChecklist('step2', 'completed');
              updateChecklist('step3', 'in-progress');
              google.script.run
                .withSuccessHandler(function() {
                  updateChecklist('step3', 'completed');
                  updateChecklist('step4', 'in-progress');
                  google.script.run
                    .withSuccessHandler(handleImageInsertionResult)
                    .withFailureHandler(handleImageInsertionError)
                    .handleImageInsertion();
                })
                .withFailureHandler(function(error) {
                  resetForm();
                  showModal('Failed to sort files: ' + error);
                })
                .sortFiles();
            })
            .withFailureHandler(function(error) {
              resetForm();
              showModal('Failed to collect files: ' + error);
            })
            .collectFiles(folderUrl);
        })
        .withFailureHandler(function(error) {
          resetForm();
          showModal('Failed to initialize process: ' + error);
        })
        .initializeProcess(folderUrl, startRow, startCol);
    }

    function handleImageInsertionResult(result) {
      console.log("Image insertion result:", result);
      if (result === 'completed') {
        updateChecklist('step4', 'completed');
        updateChecklist('step5', 'completed');
        resetForm();
        showModal('Process completed. All images inserted.');
      } else if (result === 'continuing') {
        updateChecklist('step4', 'in-progress');
        showModal('Batch completed. Processing will continue automatically.');
      } else if (result === 'stopped') {
        resetForm();
        showModal('Process stopped by user.');
      } else {
        resetForm();
        showModal('An error occurred during image insertion: ' + result);
      }
    }

    function handleImageInsertionError(error) {
      console.error("Image insertion error:", error);
      resetForm();
      showModal('Failed to insert images: ' + error);
    }

    function previewSortOrder() {
      const folderUrl = document.getElementById('folderUrl').value;

      if (!folderUrl) {
        alert('Please enter the folder URL.');
        return;
      }
      showSpinner('previewSpinner');
      google.script.run
        .withSuccessHandler(function(sortedFiles) {
          resetForm();
          hideSpinner('previewSpinner');
          displaySortedFiles(sortedFiles);
        })
        .withFailureHandler(function(error) {
          resetForm();
          hideSpinner('previewSpinner');
          alert('Failed to preview sorted files: ' + error);
        })
        .collectAndSortFiles(folderUrl);
    }

    function displaySortedFiles(sortedFiles) {
      const modal = document.getElementById('myModal');
      const modalContent = document.querySelector('.modal-content');
      const message = document.getElementById('modalMessage');
      
      // Clear previous content
      message.innerHTML = '';
      
      // Add title
      const title = document.createElement('h3');
      title.textContent = 'Sorted Files';
      message.appendChild(title);
      
      // Add file list
      const fileList = document.createElement('ol');
      sortedFiles.forEach(file => {
        const li = document.createElement('li');
        li.textContent = file;
        fileList.appendChild(li);
      });
      message.appendChild(fileList);
      
      // Add file count
      const count = document.createElement('p');
      count.textContent = `Total files: ${sortedFiles.length}`;
      message.appendChild(count);
      
      modal.style.display = 'block';
    }

    function stopScript() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result) {
            resetForm();
            showModal('Process stopped by user.');
          }
        })
        .stopImageInsertion();
    }

    function resetForm() {
      disableForm(false);
      hideSpinner('mainSpinner');
      resetChecklist();
      document.getElementById('submitButton').value = 'Insert Images';
      document.getElementById('submitButton').onclick = submitForm;
    }

    function updateChecklist(stepId, status) {
      const stepElement = document.getElementById(stepId);
      stepElement.classList.remove('in-progress', 'completed');
      stepElement.classList.add(status);
    }

    function resetChecklist() {
      const checklistItems = document.querySelectorAll('.checklist li');
      checklistItems.forEach(item => {
        item.classList.remove('in-progress', 'completed');
      });
    }

    function disableForm(disable) {
      const formElements = document.querySelectorAll('#imageForm input[type="text"], #imageForm input[type="number"]');
      formElements.forEach(element => {
        element.disabled = disable;
        if (disable) {
          element.classList.add('disabled');
        } else {
          element.classList.remove('disabled');
        }
      });
    }

    function showSpinner(spinnerId) {
      document.getElementById(spinnerId).style.display = 'inline-block';
    }

    function hideSpinner(spinnerId) {
      document.getElementById(spinnerId).style.display = 'none';
    }

    function showModal(message) {
      const modal = document.getElementById('myModal');
      const modalMessage = document.getElementById('modalMessage');
      modalMessage.innerText = message;
      modal.style.display = 'block';
    }

    function closeModal() {
      const modal = document.getElementById('myModal');
      modal.style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('myModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  </script>
</body>
</html>